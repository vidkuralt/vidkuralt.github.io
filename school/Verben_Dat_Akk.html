<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Verben mit Pr√§positionen Trainer</title>
<style>
    body { font-family: Arial; max-width: 700px; margin: 40px auto; }
    input { padding: 8px; width: 100%; margin-top: 5px; box-sizing: border-box; }
    button { padding: 10px; margin-top: 10px; width: 100%; cursor: pointer; }
    #result { margin-top: 20px; font-size: 1.2em; }
    #score { margin-top: 10px; font-weight: bold; }
    #leftCount { margin-top: 6px; color: #333; }
    #history { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align:center; }
    .trainer-container { border: 1px solid #ccc; padding: 20px; border-radius: 8px; background: #f9f9f9; }
    .toggle-container { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
</style>
</head>
<body>

<h2>Verben mit Pr√§positionen ‚Äì Trainer</h2>

<div class="trainer-container">
    <div class="toggle-container">
        <input type="checkbox" id="modeToggle" onchange="toggleMode()">
        <label for="modeToggle"><strong>Include Case (Dativ/Akkusativ)</strong></label>
    </div>

    <p id="verbDisplay"></p>

    <input id="prepInput" placeholder="Pr√§position (z. B. auf)">
    <input id="caseInput" placeholder="Kasus (akk / dat)" style="display:none;">

    <button onclick="checkAnswer()">√úberpr√ºfen</button>
    <button onclick="showHistory()">Show Results</button>

    <div id="result"></div>
    <div id="score"></div>
    <div id="leftCount"></div>
</div>

<div id="history"></div>

<script>
// ------------------- Database -----------------------
const verbs = { "abh√§ngen": [ { prep: "von", case: "dat" } ], "achten": [ { prep: "auf", case: "akk" } ], "anfangen": [ { prep: "mit", case: "dat" } ], "anrufen": [ { prep: "bei", case: "dat" } ], "antworten": [ { prep: "auf", case: "akk" } ], "arbeiten": [ { prep: "als", case: "nom" }, { prep: "bei", case: "dat" }, { prep: "an", case: "dat" } ], "sich √§rgern": [ { prep: "√ºber", case: "akk" } ], "aufh√∂ren": [ { prep: "mit", case: "dat" } ], "bedeuten": [ { prep: "f√ºr", case: "akk" } ], "sich beeilen": [ { prep: "mit", case: "dat" } ], "beginnen": [ { prep: "mit", case: "dat" } ], "berichten": [ { prep: "√ºber", case: "akk" }, { prep: "von", case: "dat" } ], "beschweren": [ { prep: "bei", case: "dat" }, { prep: "√ºber", case: "akk" } ], "bestehen": [ { prep: "aus", case: "dat" } ], "bitten": [ { prep: "um", case: "akk" } ], "danken": [ { prep: "f√ºr", case: "akk" } ], "demonstrieren": [ { prep: "f√ºr", case: "akk" } ], "denken": [ { prep: "an", case: "akk" } ], "diskutieren": [ { prep: "√ºber", case: "akk" }, { prep: "mit", case: "dat" } ], "sich einigen": [ { prep: "auf", case: "akk" }, { prep: "mit", case: "dat" } ], "einladen": [ { prep: "zu", case: "dat" } ], "sich engagieren": [ { prep: "f√ºr", case: "akk" } ], "sich entscheiden": [ { prep: "f√ºr", case: "akk" }, { prep: "gegen", case: "akk" } ], "sich entschuldigen": [ { prep: "f√ºr", case: "akk" }, { prep: "bei", case: "dat" } ], "entstehen": [ { prep: "aus", case: "dat" } ], "sich erholen": [ { prep: "von", case: "dat" } ], "sich erinnern": [ { prep: "an", case: "akk" } ], "erwarten": [ { prep: "von", case: "dat" } ], "erz√§hlen": [ { prep: "von", case: "dat" } ], "sich freuen": [ { prep: "auf", case: "akk" }, { prep: "√ºber", case: "akk" } ], "fragen": [ { prep: "nach", case: "dat" } ], "es geht": [ { prep: "um", case: "akk" } ], "geh√∂ren": [ { prep: "zu", case: "dat" } ], "gelten": [ { prep: "als", case: "akk" } ], "sich gew√∂hnen": [ { prep: "an", case: "akk" } ], "glauben": [ { prep: "an", case: "akk" } ], "gratulieren": [ { prep: "zu", case: "dat" } ], "handeln": [ { prep: "von", case: "dat" }, { prep: "mit", case: "dat" } ], "helfen": [ { prep: "bei", case: "dat" }, { prep: "mit", case: "dat" } ], "teilnehmen": [ { prep: "an", case: "dat" } ], "sprechen": [ { prep: "√ºber", case: "akk" }, { prep: "mit", case: "dat" }, { prep: "von", case: "dat" } ], "sich informieren": [ { prep: "√ºber", case: "akk" } ], "sich interessieren": [ { prep: "f√ºr", case: "akk" } ], "k√§mpfen": [ { prep: "f√ºr", case: "akk" }, { prep: "gegen", case: "akk" }, { prep: "mit", case: "dat" }, { prep: "um", case: "akk" } ], "sich konzentrieren": [ { prep: "auf", case: "akk" } ], "sich k√ºmmern": [ { prep: "um", case: "akk" } ], "lachen": [ { prep: "√ºber", case: "akk" } ], "leiden": [ { prep: "an", case: "dat" }, { prep: "unter", case: "dat" } ], "lesen": [ { prep: "von", case: "dat" }, { prep: "√ºber", case: "akk" } ], "passen": [ { prep: "zu", case: "dat" } ], "protestieren": [ { prep: "gegen", case: "akk" } ], "reagieren": [ { prep: "auf", case: "akk" } ], "riechen": [ { prep: "nach", case: "dat" } ], "schicken": [ { prep: "an", case: "akk" } ], "schimpfen": [ { prep: "√ºber", case: "akk" }, { prep: "mit", case: "dat" } ], "sich spezialisieren": [ { prep: "auf", case: "akk" } ], "sterben": [ { prep: "an", case: "dat" } ], "steigen": [ { prep: "auf", case: "akk" } ], "sich streiten": [ { prep: "mit", case: "dat" }, { prep: "√ºber", case: "akk" } ], "suchen": [ { prep: "nach", case: "dat" } ], "tauschen": [ { prep: "gegen", case: "akk" } ], "telefonieren": [ { prep: "mit", case: "dat" } ], "tr√§umen": [ { prep: "von", case: "dat" } ], "sich treffen": [ { prep: "mit", case: "dat" } ], "√ºbersetzen": [ { prep: "in", case: "akk" }, { prep: "aus", case: "dat" } ], "√ºberzeugen": [ { prep: "von", case: "dat" } ], "sich unterhalten": [ { prep: "√ºber", case: "akk" }, { prep: "mit", case: "dat" } ], "sich verabreden": [ { prep: "mit", case: "dat" } ], "sich verlieben": [ { prep: "in", case: "akk" } ], "verzichten": [ { prep: "auf", case: "akk" } ], "sich vorbereiten": [ { prep: "auf", case: "akk" } ], "warnen": [ { prep: "vor", case: "dat" } ], "warten": [ { prep: "auf", case: "akk" } ], "sich wundern": [ { prep: "√ºber", case: "akk" } ], "zweifeln": [ { prep: "an", case: "dat" } ] };

// ------------------- Helper -----------------------
function normalize(text) {
  return String(text || "").toLowerCase()
             .replace(/√§/g, "a")
             .replace(/√∂/g, "o")
             .replace(/√º/g, "u")
             .replace(/√ü/g, "ss")
             .trim();
}

// ------------------- State -----------------------
let includeCase = false;
let correct = 0;
let wrong = 0;
let history = [];

// lists of question items (each verb-prep-case is one item)
let initialList = [];     // shuffled list of all items (initial pass)
let repeatList = [];      // items answered wrong to be repeated
let currentList = [];     // currently used list (initialList or repeatList)
let currentIndex = 0;     // index inside currentList
let currentItem = null;   // currently shown item

// ------------------- Build & shuffle questions -----------------------
function buildLists() {
  initialList = [];
  for (const verb of Object.keys(verbs)) {
    verbs[verb].forEach(entry => {
      initialList.push({ verb, prep: entry.prep, case: entry.case });
    });
  }
  // Fisher-Yates shuffle
  for (let i = initialList.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [initialList[i], initialList[j]] = [initialList[j], initialList[i]];
  }
  repeatList = [];
  currentList = initialList.slice();
  currentIndex = 0;
}

// ------------------- Helper: update counter -----------------------
function updateLeftCount() {
  const left = Math.max(0, currentList.length - currentIndex);
  document.getElementById("leftCount").textContent = `Verbleibende Artikel: ${left} (in dieser Runde)`;
}

// ------------------- Mode toggle -----------------------
function toggleMode() {
  includeCase = document.getElementById("modeToggle").checked;
  document.getElementById("caseInput").style.display = includeCase ? "block" : "none";
  document.getElementById("result").textContent = "";
}

// ------------------- Start next round -----------------------
function newRound() {
  // If no more items in current list, attempt to switch to repeat list
  if (currentIndex >= currentList.length) {
    if (repeatList.length > 0) {
      // Start repeating mistakes in random order
      currentList = repeatList.slice();
      // shuffle repeat list
      for (let i = currentList.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [currentList[i], currentList[j]] = [currentList[j], currentList[i]];
      }
      repeatList = [];
      currentIndex = 0;
    } else {
      // Everything finished
      currentItem = null;
      document.getElementById("verbDisplay").textContent = "üéâ Alle Verben abgeschlossen!";
      updateLeftCount();
      return;
    }
  }

  currentItem = currentList[currentIndex];
  document.getElementById("verbDisplay").textContent = `Verb: ${currentItem.verb}`;
  document.getElementById("prepInput").value = "";
  document.getElementById("caseInput").value = "";
  document.getElementById("result").textContent = "";
  updateScore();
  updateLeftCount();
}

// ------------------- Score -----------------------
function updateScore() {
  document.getElementById("score").textContent = `Score: ‚úÖ ${correct} | ‚ùå ${wrong}`;
}

// ------------------- Check Answer -----------------------
function checkAnswer() {
  if (!currentItem) return;

  const userPrep = normalize(document.getElementById("prepInput").value);
  const userCase = normalize(document.getElementById("caseInput").value);

  // Get all valid options for this verb
  const options = verbs[currentItem.verb];

  // Check if user input matches any valid option
  const isCorrect = options.some(opt => {
    const prepMatch = userPrep === normalize(opt.prep);
    const caseMatch = includeCase ? (userCase === normalize(opt.case)) : true;
    return prepMatch && caseMatch;
  });

  history.push({
    verb: currentItem.verb,
    yourPrep: userPrep || "(empty)",
    yourCase: includeCase ? (userCase || "(empty)") : "‚Äî",
    correctPrep: options.map(o => o.prep).join(" / "), // show all valid options
    correctCase: includeCase ? options.map(o => o.case).join(" / ") : "‚Äî",
    mode: includeCase ? "Prep + Case" : "Prep only",
    result: isCorrect ? "Correct" : "Wrong",
    timestamp: new Date().toISOString()
  });

  if (isCorrect) {
    correct++;
    document.getElementById("result").textContent = "‚úÖ Richtig!";
  } else {
    wrong++;
    document.getElementById("result").textContent =
      `‚ùå Falsch! Richtig: "${options.map(o => o.prep + (includeCase ? ' + ' + o.case : '')).join(' / ')}"`;

    // add to repeat list (avoid duplicates)
    const exists = repeatList.some(it =>
      it.verb === currentItem.verb && it.prep === currentItem.prep && it.case === currentItem.case
    );
    if (!exists) repeatList.push({ ...currentItem });
  }

  updateScore();

  currentIndex++;
  setTimeout(newRound, 900);
}

// ------------------- Show history + CSV export -----------------------
function showHistory() {
  let html = "<h3>Ergebnisse</h3>";
  html += `<button onclick="exportCSV()">Export CSV</button><br><br>`;
  html += "<table>";
  html += "<tr><th>Verb</th><th>Your Prep</th><th>Your Case</th><th>Correct Prep</th><th>Correct Case</th><th>Mode</th><th>Result</th></tr>";

  history.forEach(item => {
    html += `<tr>
      <td>${item.verb}</td>
      <td>${item.yourPrep}</td>
      <td>${item.yourCase}</td>
      <td>${item.correctPrep}</td>
      <td>${item.correctCase}</td>
      <td>${item.mode}</td>
      <td>${item.result === "Correct" ? "‚úÖ" : "‚ùå"}</td>
    </tr>`;
  });

  html += "</table>";
  document.getElementById("history").innerHTML = html;
}

// ------------------- CSV Export -----------------------
function exportCSV() {
  if (history.length === 0) {
    alert("Keine Ergebnisse zum Exportieren.");
    return;
  }

  const rows = [
    ["Verb", "Your Prep", "Your Case", "Correct Prep", "Correct Case", "Mode", "Result", "Timestamp"]
  ];

  history.forEach(h => {
    rows.push([h.verb, h.yourPrep, h.yourCase, h.correctPrep, h.correctCase, h.mode, h.result, h.timestamp]);
  });

  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "verb_trainer_results.csv";
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ------------------- Submit on Enter -----------------------
document.getElementById("prepInput").addEventListener("keypress", function(e) {
  if (e.key === "Enter") checkAnswer();
});
document.getElementById("caseInput").addEventListener("keypress", function(e) {
  if (e.key === "Enter") checkAnswer();
});

// ------------------- Start -----------------------
buildLists();
newRound();
</script>

</body>
</html>
